# LightTag 5-LED 6DoF 定位系統 — 技術參考文件

## 1. 系統概述

LightTag 是一個硬體 LED 設備，配備 **5 顆藍光定位 LED** 和 **3 條數據燈條**。
WebTag 是對應的瀏覽器端定位系統，通過手機相機捕捉 LED 影像，計算相機相對於 LightTag 的 **6DoF（六自由度）位姿**。

### 設計目標
- 純 Web 端運行（無需安裝 App）
- 2–5 公尺有效定位範圍
- 位置精度 ≤ 10cm
- 即時定位（15–30 FPS）

---

## 2. 硬體結構

### 2.1 外觀

LightTag 外觀為綠色貓耳造型機器人。主要發光元件分為兩類：
- **定位 LED**：5 顆藍光 LED，用於 6DoF 空間定位
- **數據燈條**：3 條水平 LED 燈帶，用於 96-bit 光學編碼傳輸

### 2.2 座標系定義

```
原點：中間數據燈條（STRIP_MID）的中心
+X 軸：向右
+Y 軸：向上
+Z 軸：朝向相機（從設備向觀測者方向）
單位：毫米（mm）
```

### 2.3 五顆定位 LED

| LED | 位置 (x, y, z) mm | 角色 | 說明 |
|-----|-------------------|------|------|
| LED1 | (62, 43.3, 0) | 右上角 | 平面矩形頂點 |
| LED2 | (62, -43.3, 0) | 右下角 | 平面矩形頂點 |
| LED3 | (-62, -43.3, 0) | 左下角 | 平面矩形頂點 |
| LED4 | (-62, 43.3, 0) | 左上角 | 平面矩形頂點 |
| LED5 | (0, 151.6, 40) | 頂部中央 | **非共面突起點** |

> ⚠️ **注意座標版本差異**：PRD-5LED-Localization.md 中記錄的是早期較小尺寸 (33.65, 21.80)。
> geometry-matcher.js 中的座標 (62, 43.3) 為 **最新正式版本**，以此為準。

#### LED 物理規格
- **直徑**：6.0 mm
- **波長**：藍光 ~450nm
- **LED1–4 水平跨距**：124 mm（左右各 62mm）
- **LED1–4 垂直跨距**：86.6 mm（上下各 43.3mm）
- **LED5 突起高度**：40 mm（Z 軸方向向前伸出）
- **LED5 與基座的 Y 距離**：LED5 Y=151.6mm，基座頂端 Y=43.3mm → 間距 108.3mm

#### 幾何特性

```
         LED5 (0, 151.6, 40)    ← 非共面突起點
           ●
          /|\
         / | \
        /  |  \
  LED4 ●───┼───● LED1
  (-62,43.3,0) (62,43.3,0)
       |       |
       |   O   |               ← 原點 (0,0,0)
       |       |
  LED3 ●───────● LED2
  (-62,-43.3,0) (62,-43.3,0)
```

**關鍵設計**：LED1–4 共面（Z=0），LED5 非共面（Z=40）。
這個「4+1」配置是消除 PnP 翻轉歧義的核心設計。

### 2.4 三條數據燈條

| 燈條 | 中心 (cx, cy, z) mm | 半寬 | 半高 | 全尺寸 |
|------|---------------------|------|------|--------|
| STRIP_TOP | (0, 43.3, 0) | 48mm | 26.8mm | 96×53.6mm |
| STRIP_MID | (0, 0, 0) | 48mm | 26.8mm | 96×53.6mm |
| STRIP_BOT | (0, -43.3, 0) | 48mm | 26.8mm | 96×53.6mm |

#### 燈條邊緣參考點（6 個）

| 點位 | 位置 (x, y, z) mm | 說明 |
|------|-------------------|------|
| ST_L | (-48, 43.3, 0) | 頂部燈條左邊緣中點 |
| ST_R | (48, 43.3, 0) | 頂部燈條右邊緣中點 |
| SM_L | (-48, 0, 0) | 中間燈條左邊緣中點 |
| SM_R | (48, 0, 0) | 中間燈條右邊緣中點 |
| SB_L | (-48, -43.3, 0) | 底部燈條左邊緣中點 |
| SB_R | (48, -43.3, 0) | 底部燈條右邊緣中點 |

#### 燈條物理規格
- **全寬**：96.0 mm
- **全高**：53.6 mm
- **燈條間距**（中心到中心）：43.3 mm
- **功能**：3-LED 並行傳輸，每幀 3-bit，96-bit 封包（32 幀完成）

### 2.5 空間關係圖（正面視角）

```
                    ● LED5 (突起 40mm)
                    |
                    | 108.3mm
                    |
  LED4 ●────────────┼────────────● LED1
       |  ┌──── STRIP_TOP ────┐  |
       |  │    96mm × 53.6mm  │  |
       |  └───────────────────┘  |
       |  ┌──── STRIP_MID ────┐  |
       |  │       (原點)       │  |
       |  └───────────────────┘  |
       |  ┌──── STRIP_BOT ────┐  |
  LED3 ●──┘    96mm × 53.6mm  └──● LED2
       |←── 124mm (LED跨距) ──→|
       |←── 96mm (燈條寬) ───→|
```

---

## 3. 6DoF 定位原理

### 3.1 什麼是 6DoF

六自由度（6 Degrees of Freedom）描述物體在三維空間中的完整位姿：

| 自由度 | 分量 | 說明 |
|--------|------|------|
| 平移 X (tx) | 左右移動 | 相機相對設備的水平偏移 |
| 平移 Y (ty) | 上下移動 | 相機相對設備的垂直偏移 |
| 平移 Z (tz) | 前後移動 | 相機與設備的距離 |
| 旋轉 Roll | 繞 Z 軸旋轉 | 相機的傾斜角 |
| 旋轉 Pitch | 繞 X 軸旋轉 | 相機的俯仰角 |
| 旋轉 Yaw | 繞 Y 軸旋轉 | 相機的偏擺角 |

### 3.2 PnP 演算法（Perspective-n-Point）

PnP 是 6DoF 定位的數學核心。已知 n 個 3D 點的世界座標及其在影像中的 2D 投影位置，求解相機的旋轉矩陣 R 和平移向量 t。

#### 數學模型

相機投影模型（針孔模型）：

```
        [fx  0  cx]   [r11 r12 r13 | tx]   [X]
s [u] = [ 0 fy  cy] × [r21 r22 r23 | ty] × [Y]
  [v]   [ 0  0   1]   [r31 r32 r33 | tz]   [Z]
  [1]                                        [1]

其中：
  (u, v) = 影像上的 2D 像素座標
  (X, Y, Z) = LED 的 3D 世界座標 (mm)
  [fx, fy, cx, cy] = 相機內參（焦距、主點）
  [R | t] = 相機外參（旋轉 + 平移）= 我們要求的 6DoF
  s = 深度縮放因子
```

#### WebTag 的兩階段求解

**階段 1：DLT（Direct Linear Transform）— 初始估計**

1. 將 2D 影像座標標準化：`u_norm = (u - cx) / fx`
2. 建立 2n × 12 矩陣 A（每個點提供 2 個方程式）
3. 對 A 做 SVD 分解，取最小奇異值對應的向量
4. 提取 3×4 投影矩陣 P = [R | t]
5. 用 SVD 將提取的 R 強制正交化為合法旋轉矩陣
6. 確保 det(R) = 1 且 Z 深度為正

**階段 2：Levenberg-Marquardt（LM）— 非線性精煉**

1. 將旋轉矩陣轉換為 Rodrigues 向量（3 參數）
2. 與平移向量合併為 6 參數向量 θ = [rx, ry, rz, tx, ty, tz]
3. 最小化重投影誤差：
   ```
   E(θ) = Σᵢ ||project(Pᵢ, θ) - qᵢ||²

   其中 Pᵢ = 第 i 個 LED 的 3D 座標
         qᵢ = 第 i 個 LED 在影像中的觀測 2D 位置
   ```
4. 迭代求解（最多 30 次迭代）：
   ```
   (JᵀJ + λI) Δθ = Jᵀr

   J = 雅可比矩陣（6×2n，數值微分計算）
   r = 殘差向量
   λ = 阻尼因子（自適應調整）
   ```
5. 收斂條件：殘差變化 < 1e-8

#### Rodrigues 旋轉表示

```
旋轉向量 rvec = [rx, ry, rz]
旋轉角度 θ = ||rvec||
旋轉軸   k = rvec / θ

旋轉矩陣 R = I·cos(θ) + [k]× · sin(θ) + k⊗k · (1-cos(θ))

其中 [k]× 為反對稱矩陣（叉積矩陣）
```

#### Euler 角提取

```
sy = sqrt(R[0,0]² + R[1,0]²)

若 sy > 1e-6（非奇異）：
  Roll  = atan2(R[2,1], R[2,2])
  Pitch = atan2(-R[2,0], sy)
  Yaw   = atan2(R[1,0], R[0,0])

若 sy ≤ 1e-6（萬向鎖）：
  Roll  = atan2(-R[1,2], R[1,1])
  Pitch = atan2(-R[2,0], sy)
  Yaw   = 0
```

### 3.3 非共面設計的必要性

**為什麼 LED5 必須突起？**

若 5 個 LED 全部共面（Z=0），PnP 會產生兩個數學上等效的解（翻轉歧義）：
- 解 A：設備在相機前方 3m
- 解 B：設備在相機後方 3m（鏡像翻轉）

LED5 的 40mm 突起提供了關鍵的 **視差（Parallax）** 信息：
- 當相機角度微調時，LED5 相對於 LED1–4 的 2D 位移非常明顯
- 這消除了翻轉歧義，同時大幅提升 Roll 和 Pitch 的估計精度

### 3.4 相機內參處理

WebTag 無法取得每部手機的工廠校正參數，採用估計方式：

```javascript
f = 0.9 × max(width, height)    // 焦距估計
fx = fy = f                      // 假設等焦距
cx = width / 2                   // 主點 = 影像中心
cy = height / 2
```

在 2–4m 範圍內，這個估計的焦距誤差約 ±2%，對應 10cm 以內的定位誤差。

---

## 4. 完整定位流程

```
┌─────────────────────────────────────────────────┐
│  Step 1: 影像擷取                                │
│  手機相機 → 1080×1920 視訊流 → 逐幀處理          │
└─────────────────┬───────────────────────────────┘
                  ▼
┌─────────────────────────────────────────────────┐
│  Step 2: 藍光濾波 (GPU, WebGL)                   │
│                                                  │
│  輸入：原始影像幀                                 │
│  處理：                                          │
│    brightness = max(R, G, B)                     │
│    blueDiff = B - (R+G)/2                        │
│    brightnessGate = smoothstep(threshold, ...)   │
│    blueWeight = smoothstep(-0.05, 0.15, blueDiff)│
│    finalScore = brightnessGate × blueWeight      │
│                                                  │
│  輸出：                                          │
│    R 通道 = 綜合分數（亮度門 × 藍色權重）         │
│    G 通道 = blueDiff + 0.5（色彩資訊）            │
│    B 通道 = 原始亮度                              │
│                                                  │
│  降採樣 2× → 960×540                             │
└─────────────────┬───────────────────────────────┘
                  ▼
┌─────────────────────────────────────────────────┐
│  Step 3: 峰值偵測 (NMS)                          │
│                                                  │
│  輸入：遮罩分數圖（R 通道）                       │
│  處理：                                          │
│    1. 建立分數圖（mask 值 + 飽和度修正）          │
│    2. 條件模糊（藍色佔比 ≥15% 時 3×3 均值）       │
│    3. 非極大值抑制（NMS, 7×7 窗口）               │
│    4. 亞像素精煉（5×5 加權重心）                  │
│    5. 形態分析（pointiness, isotropy）            │
│                                                  │
│  輸出：最多 20 個峰值候選點                       │
│  篩選條件：                                      │
│    - 峰值分數 > 80                               │
│    - pointiness > 1.05                           │
│    - isotropy > 0.3                              │
│    - 真實亮度 > 80                               │
└─────────────────┬───────────────────────────────┘
                  ▼
┌─────────────────────────────────────────────────┐
│  Step 4: Blob 偵測 (Connected Component)         │
│                                                  │
│  輸入：遮罩分數圖（R 通道）                       │
│  處理：                                          │
│    1. 二值化（threshold > 120）                   │
│    2. Union-Find 連通域標記（4-鄰接）             │
│    3. 統計每個連通域的面積、質心、邊界框           │
│                                                  │
│  LED Blob 篩選：                                  │
│    - 面積：2–300 pixels                           │
│    - 長寬比 ≤ 2.5                                │
│    - 真實亮度 ≥ 100                              │
│    - 緊湊度 ≥ 0.3                                │
│                                                  │
│  燈條偵測（另一組篩選）：                         │
│    - 面積：40–50000 pixels                        │
│    - 長寬比 ≥ 1.5（水平延伸）                    │
│    - 提取左右邊緣中點                             │
│                                                  │
│  輸出：LED blob 列表 + 燈條列表                   │
└─────────────────┬───────────────────────────────┘
                  ▼
┌─────────────────────────────────────────────────┐
│  Step 5: 候選合併                                │
│                                                  │
│  策略：峰值優先，Blob 補充                        │
│    1. 納入所有峰值候選                            │
│    2. 加入距離所有峰值 > 2% 影像寬度的 Blob       │
│    3. 按複合分數排序：realBrightness×0.5 + blue×0.5│
│    4. 取前 20 個                                  │
│                                                  │
│  輸出：合併的候選點列表（最多 20 個）              │
└─────────────────┬───────────────────────────────┘
                  ▼
┌─────────────────────────────────────────────────┐
│  Step 6: 幾何匹配                                │
│                                                  │
│  燈條匹配：                                      │
│    - 對所有候選燈條做 C(n,3) 組合評分             │
│    - 評分權重：間距一致性 40% + 寬度一致性 25%     │
│      + X 對齊 20% + 亮度一致性 15%               │
│    - 閾值：score ≥ 0.3                           │
│                                                  │
│  LED 匹配（使用燈條作為空間錨點）：               │
│    - LED5：最高且最接近水平中心                    │
│    - LED1/2：燈條右側，按 Y 排序                  │
│    - LED3/4：燈條左側，按 Y 排序                  │
│                                                  │
│  驗證：                                          │
│    - 至少 4 個特徵點                              │
│    - 空間分佈度 ≥ 0.3（歸一化對角線距離）         │
│                                                  │
│  輸出：2D–3D 對應點集                             │
└─────────────────┬───────────────────────────────┘
                  ▼
┌─────────────────────────────────────────────────┐
│  Step 7: PnP 求解                                │
│                                                  │
│  輸入：                                          │
│    - objectPoints: LED 的 3D 世界座標 (mm)        │
│    - imagePoints: LED 的 2D 影像座標 (pixels)     │
│    - 相機內參 [fx, fy, cx, cy]                   │
│                                                  │
│  求解：DLT 初始估計 → LM 非線性精煉              │
│                                                  │
│  輸出：                                          │
│    - rvec: Rodrigues 旋轉向量 (3 分量, radians)   │
│    - tvec: 平移向量 [tx, ty, tz] (mm)            │
│    - euler: [Roll, Pitch, Yaw] (degrees)         │
│    - distance: sqrt(tx²+ty²+tz²) / 1000 (meters)│
│    - reprojError: 重投影 RMS 誤差 (pixels)        │
└─────────────────┬───────────────────────────────┘
                  ▼
┌─────────────────────────────────────────────────┐
│  Step 8: 追蹤穩定化                              │
│                                                  │
│  Kalman 濾波器平滑連續幀的位姿輸出                │
│  失敗時回退到全局重新偵測                         │
│  信心分數 = f(reprojError, SNR, 連續成功幀數)     │
│                                                  │
│  最終輸出：                                      │
│    - 6DoF 位姿（實時更新）                        │
│    - 距離（公尺）                                 │
│    - 穩定度指標                                   │
└─────────────────────────────────────────────────┘
```

---

## 5. 目前已知問題與限制

### 5.1 相機對焦

Android Chrome 的 `focusDistance`、`pointsOfInterest`、`single-shot` 等對焦 API 在大多數設備上**無法實際控制硬體**。瀏覽器接受設定但不報錯。目前只能依靠 `continuous` 自動對焦。

### 5.2 LED 光暈融合

在模糊畫面中，5 個 6mm LED 的光暈會重疊融合成一大團亮斑。目前的偵測管線缺乏分離重疊光暈的能力：
- NMS 在融合光暈中只找到一個最大值
- Connected Component 將整團標記為一個 blob
- 需要引入 LoG（高斯差分）或形態學分離演算法

### 5.3 參考截圖

早期版本（HSV 濾波器 + 近距離清晰畫面）能成功分離出 5 個獨立 LED 點（見 ref/IMG_6783.PNG, IMG_6784.PNG, IMG_6785.PNG）。這證明硬體本身沒有問題，問題在於：
1. 遠距離或模糊條件下光暈融合
2. 目前的濾波器策略未針對此場景優化

---

## 6. 精度分析

### 6.1 像素角分辨率

在 1080p（1920×1080）下，假設水平 FOV ≈ 70°：
- 每像素角分辨率 ≈ 70° / 1920 ≈ 0.036°
- 亞像素精煉可達 0.1–0.5 pixel → 0.004°–0.018° 角精度

### 6.2 距離精度

LED 基線 124mm，在不同距離下的 LED 間距（像素）：

| 距離 | LED 跨距 (px) | 亞像素誤差影響 | 預期距離精度 |
|------|-------------|-------------|------------|
| 1m | ~170 px | ±0.3% | ±3 cm |
| 2m | ~85 px | ±0.6% | ±12 cm |
| 3m | ~57 px | ±0.9% | ±27 cm |
| 5m | ~34 px | ±1.5% | ±75 cm |

### 6.3 成功條件

```
v1 Gate 標準：
- 5m 距離可穩定偵測 5 顆藍燈
- PnP 位姿輸出穩定（連續 3 秒不掉點）
- 平均誤差 ≤ 10 cm（2–5m 範圍）
```

---

## 7. 檔案對照表

| 檔案 | 對應流程步驟 | 主要功能 |
|------|------------|---------|
| `blue-filter.js` | Step 2 | WebGL 藍光濾波器 |
| `peak-detector.js` | Step 3 | NMS 峰值偵測 + 亞像素精煉 |
| `blob-detector.js` | Step 4 | 連通域 blob 偵測 + 燈條偵測 |
| `geometry-matcher.js` | Step 6 | 幾何匹配（含設備座標定義） |
| `pnp-solver.js` | Step 7 | DLT + LM 的 PnP 求解 |
| `kalman.js` | Step 8 | Kalman 濾波追蹤 |
| `feedback.js` | UI | HUD 顯示 + 音效反饋 |
| `app.js` | 主控制器 | 影像擷取、流程串接、狀態管理 |

---

## 8. 參考資料

- `ref/km20-led-spec.dxf2.dxf` — LightTag 硬體尺寸圖（DXF 格式）
- `ref/IMG_6783.PNG` ~ `IMG_6785.PNG` — 早期版本 LED 偵測成功截圖
- `ref/簡報1.pptx` — 產品簡報
- `PRD-5LED-Localization.md` — 產品需求文件
- `6dof positioning Principles.md` — 6DoF 定位原理
- `Led Technology Principles.md` — LED 光學通訊原理
